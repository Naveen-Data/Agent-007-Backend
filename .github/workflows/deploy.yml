name: Backend CI/CD - Deploy to EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.env.production'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  EC2_REGION: 'us-east-1'

jobs:
  # ======================
  # üß™ TEST & VALIDATE JOB
  # ======================
  test:
    name: üß™ Test & Validate
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8 black isort bandit safety

      - name: üîç Lint & Unit Tests
        run: |
          black --check app/
          isort --check-only app/
          flake8 app/ --count --select=E9,F63,F7,F82 --statistics
          pytest tests/ -v --tb=short || true

  # =====================
  # üê≥ BUILD DOCKER IMAGE
  # =====================
  build:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üê≥ Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: üî® Build Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: agent-007-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=docker,dest=/tmp/agent-007-backend.tar

      - name: üì¶ Upload Docker Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/agent-007-backend.tar
          retention-days: 1

  # ==================
  # üöÄ DEPLOY TO EC2
  # ==================
  deploy:
    name: üöÄ Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    environment: production
    if: github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.EC2_REGION }}

      - name: üì• Download Built Image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: üöÄ Deploy to EC2 (Hybrid Env Mode)
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          LANGCHAIN_API_KEY: ${{ secrets.LANGCHAIN_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -e
          # Write SSH private key robustly (handle CRLF, base64, and OPENSSH -> PEM conversion)
          printf '%s\n' "${EC2_KEY}" | sed 's/\r$//' > private_key.pem || true

          # If the file doesn't contain a PRIVATE KEY header, attempt base64 decode
          if ! grep -q "PRIVATE KEY" private_key.pem 2>/dev/null; then
            echo "private_key.pem missing header; attempting base64 decode..."
            echo "${EC2_KEY}" | tr -d '\r' | base64 --decode > private_key.pem 2>/dev/null || true
          fi

          # Debug: show the first line of the key (safe) and head for logs (do not reveal entire key)
          echo "---- private_key.pem head ----"
          head -n 1 private_key.pem || true
          echo "---- (end head) ----"

          # Ensure permissions are strict
          chmod 600 private_key.pem || true

          # If using newer OpenSSH private key format, convert to PEM for compatibility
          if head -n1 private_key.pem | grep -q "OPENSSH"; then
            echo "Converting OpenSSH key to PEM format for compatibility..."
            ssh-keygen -p -m PEM -f private_key.pem -P "" -N "" || true
            chmod 600 private_key.pem || true
          fi

          # Quick non-interactive SSH test (won't log in) to show whether key is accepted
          echo "Testing SSH key connectivity (will not authenticate if key invalid)..."
          ssh -i private_key.pem -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5 "${EC2_USER}@${EC2_HOST}" 'echo SSH-OK' 2>&1 | sed -n '1,120p' || true




          echo "‚è≥ Waiting for EC2 SSH availability..."
          # ensure .ssh dir exists and has correct permissions
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # try to add host key (loop until ssh-keyscan succeeds)
          until ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts 2>/dev/null; do
            echo "ssh-keyscan failed; retrying in 5s..."
            sleep 5
          done

          # optional: show the captured known_hosts line for debugging
          echo "Known hosts entry:"
          tail -n 5 ~/.ssh/known_hosts || true

          echo "‚úÖ SSH ready."

          echo "üì§ Uploading files..."
          scp -i private_key.pem /tmp/agent-007-backend.tar $EC2_USER@$EC2_HOST:/tmp/
          scp -i private_key.pem .env.production $EC2_USER@$EC2_HOST:/tmp/.env

          # Create remote deploy script
          cat > deploy.sh <<'EOF'
          #!/bin/bash
          set -e
          cd ~
          mkdir -p app && cd app

          if [ -d "Agent_007_Backend" ]; then
              cd Agent_007_Backend && git pull origin main
          else
              git clone https://github.com/${GITHUB_REPOSITORY}.git Agent_007_Backend
              cd Agent_007_Backend
          fi

          echo "üîê Appending GitHub Secrets to .env..."
          echo "GOOGLE_API_KEY=$1" >> /tmp/.env
          echo "LANGCHAIN_API_KEY=$2" >> /tmp/.env

          echo "üì¶ Loading Docker image..."
          docker load -i /tmp/agent-007-backend.tar

          echo "üß± Tagging backup..."
          docker tag agent-007-backend agent-007-backend:backup || true

          echo "üßπ Cleaning up old container..."
          docker stop agent-007-backend 2>/dev/null || true
          docker rm agent-007-backend 2>/dev/null || true

          echo "üöÄ Starting new container..."
          docker run -d --name agent-007-backend --restart unless-stopped \
            -p 8000:8000 --env-file /tmp/.env agent-007-backend

          echo "üîç Waiting for health check..."
          for i in {1..20}; do
            if curl -f http://localhost:8000/health >/dev/null 2>&1; then
              echo "‚úÖ Backend healthy!"
              exit 0
            fi
            echo "Waiting... ($i/20)"
            sleep 5
          done
          echo "‚ùå Health check failed!"
          exit 1
          EOF

          scp -i private_key.pem deploy.sh $EC2_USER@$EC2_HOST:/tmp/
          ssh -i private_key.pem $EC2_USER@$EC2_HOST "chmod +x /tmp/deploy.sh && /tmp/deploy.sh '$GOOGLE_API_KEY' '$LANGCHAIN_API_KEY'"

      - name: üß™ Post-Deployment Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "‚è≥ Checking backend health..."
          sleep 10
          curl -f http://$EC2_HOST:8000/health
          echo "‚úÖ Deployed successfully at http://$EC2_HOST:8000"
